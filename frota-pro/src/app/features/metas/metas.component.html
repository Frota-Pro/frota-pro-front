<div class="page">

  <!-- Cabe√ßalho -->
  <div class="page-head">
    <div class="titles">
      <h2 class="page-title">Metas</h2>
      <p class="subtitle">Gest√£o de metas e indicadores</p>
    </div>

    <div class="actions">
      <button class="btn-add" type="button" (click)="openAdd()">
        <i class="fas fa-plus"></i>
        Nova Meta
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-row">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar por tipo, caminh√£o, categoria ou motorista..."
    />

    <select [(ngModel)]="filtroStatus">
      <option value="">Todos</option>
      <option value="ATIVA">Ativas</option>
      <option value="FINALIZADA">Finalizadas</option>
    </select>

    <button class="btn" type="button" (click)="carregar()" [disabled]="loading">
      <i class="fas fa-rotate"></i>
      Atualizar
    </button>
  </div>

  <div class="state" *ngIf="loading">Carregando...</div>
  <div class="state error" *ngIf="!loading && errorMsg">{{ errorMsg }}</div>

  <!-- Lista -->
  <div class="card" *ngIf="!loading && !errorMsg">
    <div class="table-wrap">
      <table class="table">
        <thead>
        <tr>
          <th>Tipo</th>
          <th>Escopo</th>
          <th>Per√≠odo</th>
          <th>Progresso</th>
          <th>Status</th>
          <th class="actions-col">A√ß√µes</th>
        </tr>
        </thead>

        <tbody>
        <tr *ngFor="let m of metasFiltradas" (dblclick)="abrirDetalhe(m)" class="row">
          <td class="strong">
            <div class="click" (click)="abrirDetalhe(m)">
              {{ m.tipoMeta || '‚Äî' }}
            </div>
            <div class="muted" *ngIf="m.descricao">{{ m.descricao }}</div>
          </td>

          <td class="truncate">
            <div *ngIf="m.caminhaoCodigo">üöö <span class="mono">{{ m.caminhaoCodigo }}</span> <span class="muted">{{ m.caminhaoDescricao }}</span></div>
            <div *ngIf="m.categoriaCodigo">üè∑Ô∏è <span class="mono">{{ m.categoriaCodigo }}</span> <span class="muted">{{ m.categoriaDescricao }}</span></div>
            <div *ngIf="m.motoristaCodigo">üë§ <span class="mono">{{ m.motoristaCodigo }}</span> <span class="muted">{{ m.motoristaDescricao }}</span></div>
            <div *ngIf="!m.caminhaoCodigo && !m.categoriaCodigo && !m.motoristaCodigo">‚Äî</div>
          </td>

          <td class="mono">
            {{ (m.dataIncio || '') | date:'dd/MM/yy' }} -
            {{ (m.dataFim || '') | date:'dd/MM/yy' }}
          </td>

          <td>
            <div class="progress-wrapper">
              <div class="progress-info">
                <span class="mono">{{ m.valorRealizado ?? 0 }}</span>
                <span class="mono">{{ m.valorMeta ?? 0 }}</span>
                <span class="muted">{{ m.unidade }}</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getProgressPercent(m)"></div>
              </div>
            </div>
          </td>

          <td>
              <span
                class="pill"
                [class.pill-success]="getStatusLabel(m) === 'ATIVA'"
                [class.pill-muted]="getStatusLabel(m) !== 'ATIVA'"
              >
                {{ getStatusLabel(m) }}
              </span>
          </td>

          <td class="actions">
            <button class="icon-btn" type="button" title="Abrir" (click)="abrirDetalhe(m)">
              <i class="fas fa-up-right-from-square"></i>
            </button>

            <button class="icon-btn edit" type="button" title="Editar" (click)="openEdit(m)">
              <i class="fas fa-pen"></i>
            </button>

            <button
              class="icon-btn success"
              type="button"
              title="Concluir"
              *ngIf="getStatusLabel(m) === 'ATIVA'"
              (click)="concluir(m)"
            >
              <i class="fas fa-check"></i>
            </button>

            <button class="icon-btn danger" type="button" title="Excluir" (click)="excluir(m)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>

        <tr *ngIf="metasFiltradas.length === 0">
          <td colspan="6" class="empty">Nenhuma meta encontrada.</td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- pagina√ß√£o -->
    <div class="pager">
      <div class="muted">
        {{ totalElements }} registros
      </div>

      <div class="pager-actions">
        <button class="btn" type="button" (click)="prevPage()" [disabled]="page<=0 || loading">Anterior</button>
        <span class="mono">P√°gina {{ page + 1 }} / {{ totalPages || 1 }}</span>
        <button class="btn" type="button" (click)="nextPage()" [disabled]="page>=totalPages-1 || loading">Pr√≥xima</button>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">

      <div class="modal-head">
        <h3>{{ editing ? 'Editar Meta' : 'Nova Meta' }}</h3>
      </div>

      <form class="modal-form" (ngSubmit)="salvar()">
        <div class="form-row">
          <div class="field">
            <label>Tipo</label>
            <select [(ngModel)]="form.tipoMeta" name="tipoMeta" required (change)="onTipoMetaChange()">
              <option value="" disabled>Selecione...</option>
              <option *ngFor="let t of tiposMeta" [value]="t.value">{{ t.label }}</option>
            </select>
          </div>

          <div class="field">
            <label>Status</label>
            <select [(ngModel)]="form.statusMeta" name="statusMeta">
              <option value="EM_ANDAMENTO">EM_ANDAMENTO</option>
              <option value="FINALIZADA">FINALIZADA</option>
              <option value="CANCELADA">CANCELADA</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Data In√≠cio</label>
            <input type="date" [(ngModel)]="form.dataIncio" name="dataIncio" required />
          </div>

          <div class="field">
            <label>Data Fim</label>
            <input type="date" [(ngModel)]="form.dataFim" name="dataFim" required />
          </div>
        </div>

        <div class="form-row three">
          <div class="field">
            <label>Valor Meta</label>
            <input type="number" step="0.01" [(ngModel)]="form.valorMeta" name="valorMeta" />
          </div>

          <div class="field">
            <label>Valor Realizado</label>
            <input type="number" step="0.01" [(ngModel)]="form.valorRealizado" name="valorRealizado" />
          </div>

          <div class="field">
            <label>Unidade</label>
            <input type="text" [(ngModel)]="form.unidade" name="unidade" placeholder="Ex: km/l" />
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Alvo</div>
          <div class="form-row">
            <div class="field">
              <label>Caminh√£o (c√≥digo)</label>
              <input type="text" [(ngModel)]="form.caminhao" name="caminhao" placeholder="Ex: CAM-000030" />
            </div>

            <div class="field">
              <label>Categoria (c√≥digo)</label>
              <input type="text" [(ngModel)]="form.categoria" name="categoria" placeholder="Ex: CAT-000001" />
            </div>
          </div>

          <div class="form-row">
            <div class="field">
              <label>Motorista (c√≥digo)</label>
              <input type="text" [(ngModel)]="form.motorista" name="motorista" placeholder="Ex: MOT-000010" />
            </div>

            <div class="checkbox-stack">
              <div class="checkbox-row">
                <input type="checkbox" [(ngModel)]="form.renovarAutomaticamente" name="renovarAutomaticamente" />
                <span>Renovar automaticamente</span>
              </div>
              <div class="checkbox-row">
                <input type="checkbox" [(ngModel)]="form.recalcularProgresso" name="recalcularProgresso" />
                <span>Recalcular progresso</span>
              </div>
            </div>
          </div>
        </div>

        <div class="field">
          <label>Descri√ß√£o</label>
          <input type="text" [(ngModel)]="form.descricao" name="descricao" placeholder="Opcional..." />
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" type="button" (click)="closeModal()">Cancelar</button>
          <button class="btn-save" type="submit" [disabled]="saving">
            {{ saving ? 'Salvando...' : (editing ? 'Salvar' : 'Cadastrar') }}
          </button>
        </div>
      </form>

    </div>
  </div>

</div>
