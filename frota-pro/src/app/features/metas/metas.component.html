<div class="page">

  <!-- Cabeçalho -->
  <div class="page-head">
    <div class="titles">
      <h2 class="page-title">Metas</h2>
      <p class="subtitle">Gestão de metas e indicadores</p>
    </div>

    <div class="actions">
      <button class="btn-add" type="button" (click)="openAddModal()">
        <i class="fas fa-plus"></i>
        Nova Meta
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-row">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar por tipo, caminhão ou motorista..."
    />

    <select [(ngModel)]="filtroStatus">
      <option value="">Todos</option>
      <option value="ATIVA">Ativas</option>
      <option value="FINALIZADA">Finalizadas</option>
    </select>
  </div>

  <!-- Lista -->
  <div class="card">
    <div class="table-wrap">
      <table class="table">
        <thead>
        <tr>
          <th>Tipo</th>
          <th>Caminhão/Motorista</th>
          <th>Período</th>
          <th>Progresso</th>
          <th>Status</th>
          <th class="actions-col">Ações</th>
        </tr>
        </thead>

        <tbody>
        <tr *ngFor="let m of metasFiltradas; trackBy: trackById">
          <td class="strong">{{ m.tipoMeta || '—' }}</td>

          <td class="truncate">
            {{ m.caminhao?.placa || '—' }}
            <span *ngIf="m.motorista?.nome"> / {{ m.motorista?.nome }}</span>
          </td>

          <td>
            {{ (m.dataInicio || '') | date:'dd/MM/yy' }} -
            {{ (m.dataFim || '') | date:'dd/MM/yy' }}
          </td>

          <td>
            <div class="progress-wrapper">
              <div class="progress-info">
                <span class="mono">{{ m.valorRealizado ?? 0 }}</span>
                <span class="mono">{{ m.valorMeta ?? 0 }}</span>
              </div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="getProgressPercent(m)"
                ></div>
              </div>
            </div>
          </td>

          <td>
              <span
                class="pill"
                [class.pill-success]="getStatusLabel(m) === 'ATIVA'"
                [class.pill-muted]="getStatusLabel(m) !== 'ATIVA'"
              >
                {{ getStatusLabel(m) }}
              </span>
          </td>

          <td class="actions">
            <button class="icon-btn edit" type="button" title="Editar" (click)="editarMeta(m)">
              <i class="fas fa-pen"></i>
            </button>

            <button
              class="icon-btn success"
              type="button"
              title="Concluir"
              *ngIf="getStatusLabel(m) === 'ATIVA'"
              (click)="finalizarMeta(m)"
            >
              <i class="fas fa-check"></i>
            </button>

            <button class="icon-btn danger" type="button" title="Excluir" (click)="excluirMeta(m.id)">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>

        <tr *ngIf="metasFiltradas.length === 0">
          <td colspan="6" class="empty">Nenhuma meta encontrada.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">

      <div class="modal-head">
        <h3>{{ editando ? 'Editar Meta' : 'Nova Meta' }}</h3>
      </div>

      <form class="modal-form" (ngSubmit)="salvarMeta()">
        <div class="form-row">
          <div>
            <label>Tipo</label>
            <input type="text" [(ngModel)]="novaMeta!.tipoMeta" name="tipoMeta" required />
          </div>

          <div>
            <label>Status</label>
            <select [(ngModel)]="novaMeta!.statusMeta" name="statusMeta">
              <option value="ATIVA">ATIVA</option>
              <option value="FINALIZADA">FINALIZADA</option>
              <option value="CANCELADA">CANCELADA</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Data Início</label>
            <input type="date" [(ngModel)]="novaMeta!.dataInicio" name="dataInicio" required />
          </div>

          <div>
            <label>Data Fim</label>
            <input type="date" [(ngModel)]="novaMeta!.dataFim" name="dataFim" required />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Valor Meta</label>
            <input type="number" step="0.01" [(ngModel)]="novaMeta!.valorMeta" name="valorMeta" />
          </div>

          <div>
            <label>Valor Realizado</label>
            <input type="number" step="0.01" [(ngModel)]="novaMeta!.valorRealizado" name="valorRealizado" />
          </div>

          <div>
            <label>Unidade</label>
            <input type="text" [(ngModel)]="novaMeta!.unidade" name="unidade" placeholder="Ex: L, km/L, R$" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Caminhão (placa)</label>
            <input type="text" [(ngModel)]="novaMeta!.caminhao!.placa" name="caminhaoPlaca"
                   (ngModelChange)="novaMeta!.caminhao = { id: novaMeta!.caminhao?.id || 'tmp', placa: $event }"
                   placeholder="Ex: ABC-1234" />
          </div>

          <div>
            <label>Motorista</label>
            <input type="text" [(ngModel)]="novaMeta!.motorista!.nome" name="motoristaNome"
                   (ngModelChange)="novaMeta!.motorista = { id: novaMeta!.motorista?.id || 'tmp', nome: $event }"
                   placeholder="Ex: João Silva" />
          </div>
        </div>

        <div>
          <label>Descrição</label>
          <input type="text" [(ngModel)]="novaMeta!.descricao" name="descricao" placeholder="Opcional..." />
        </div>

        <div class="checkbox-row">
          <input type="checkbox" [(ngModel)]="novaMeta!.renovarAutomaticamente" name="renovarAutomaticamente" />
          <span>Renovar automaticamente</span>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" type="button" (click)="closeAddModal()">Cancelar</button>
          <button class="btn-save" type="submit">{{ editando ? 'Salvar' : 'Cadastrar' }}</button>
        </div>
      </form>

    </div>
  </div>

</div>
