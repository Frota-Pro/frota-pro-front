<div class="page">

  <!-- Cabe√ßalho -->
  <div class="page-head">
    <div class="titles">
      <h2 class="page-title">Vida √ötil do Pneu</h2>
      <p class="subtitle">Acompanhamento de status, posi√ß√£o, vida √∫til (km), sulco, recapagens e custos</p>
    </div>

    <div class="actions">
      <button class="btn-secondary" type="button" (click)="filtroSomenteAlertas = !filtroSomenteAlertas">
        <i class="fas fa-bell"></i>
        {{ filtroSomenteAlertas ? 'Mostrar todos' : 'Somente alertas' }}
      </button>

      <button class="btn-add" type="button" (click)="openCadastro()">
        <i class="fas fa-plus"></i>
        Cadastrar Pneu
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpi-row">
    <div class="kpi-card">
      <div class="kpi-icon">üõû</div>
      <div class="kpi-info">
        <div class="kpi-title">Total de Pneus</div>
        <div class="kpi-value">{{ totalPneus }}</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üöö</div>
      <div class="kpi-info">
        <div class="kpi-title">Em uso</div>
        <div class="kpi-value">{{ emUso }}</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-info">
        <div class="kpi-title">Em estoque</div>
        <div class="kpi-value">{{ emEstoque }}</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">‚ôªÔ∏è</div>
      <div class="kpi-info">
        <div class="kpi-title">Recapagem</div>
        <div class="kpi-value">{{ emRecapagem }}</div>
      </div>
    </div>

    <div class="kpi-card kpi-alert">
      <div class="kpi-icon">‚ö†Ô∏è</div>
      <div class="kpi-info">
        <div class="kpi-title">Alertas</div>
        <div class="kpi-value">{{ emAlerta }}</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üí∏</div>
      <div class="kpi-info">
        <div class="kpi-title">Custo total</div>
        <div class="kpi-value">{{ custoTotalFrota | currency:'BRL' }}</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üìè</div>
      <div class="kpi-info">
        <div class="kpi-title">Custo por km</div>
        <div class="kpi-value">{{ custoPorKm | number:'1.4-6' }}</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üîÅ</div>
      <div class="kpi-info">
        <div class="kpi-title">Recapagens / pneu</div>
        <div class="kpi-value">{{ taxaMediaRecapagem | number:'1.2-2' }}</div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-row">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar por c√≥digo, fogo, s√©rie, marca, placa..."
    />

    <select [(ngModel)]="filtroStatus">
      <option value="">Todos status</option>
      <option value="EM_USO">EM_USO</option>
      <option value="ESTOQUE">ESTOQUE</option>
      <option value="RECAPAGEM">RECAPAGEM</option>
      <option value="DESCARTE">DESCARTE</option>
    </select>

    <select [(ngModel)]="filtroCaminhao">
      <option value="">Todos caminh√µes</option>
      <option *ngFor="let c of caminhoes" [value]="c.placa">{{ c.placa }}</option>
    </select>

    <select [(ngModel)]="filtroPosicao">
      <option value="">Todas posi√ß√µes</option>
      <option *ngFor="let p of posicoes" [value]="p">{{ p }}</option>
    </select>

    <input
      type="text"
      [(ngModel)]="filtroMarca"
      placeholder="Marca..."
      style="min-width: 160px;"
    />
  </div>

  <!-- Tabela -->
  <div class="card">
    <div class="table-wrap">
      <table class="table">
        <thead>
        <tr>
          <th>C√≥digo</th>
          <th>Fogo/S√©rie</th>
          <th>Marca/Modelo</th>
          <th>Medida/DOT</th>
          <th>Status</th>
          <th>Caminh√£o/Posi√ß√£o</th>
          <th>Vida √∫til</th>
          <th>Sulco</th>
          <th>Recap.</th>
          <th class="num">Custo</th>
          <th class="actions-col">A√ß√µes</th>
        </tr>
        </thead>

        <tbody>
        <ng-container *ngFor="let p of pneusFiltrados; trackBy: trackById">

          <tr class="row-click" (click)="toggleExpand(p.id)">
            <td class="strong mono">{{ p.codigo }}</td>

            <td class="truncate">
              <div class="stack">
                <span class="strong">{{ p.fogo }}</span>
                <span class="muted mono">{{ p.serie || '‚Äî' }}</span>
              </div>
            </td>

            <td class="truncate">
              <div class="stack">
                <span class="strong">{{ p.marca || '‚Äî' }}</span>
                <span class="muted">{{ p.modelo || '‚Äî' }}</span>
              </div>
            </td>

            <td class="truncate">
              <div class="stack">
                <span>{{ p.medida || '‚Äî' }}</span>
                <span class="muted mono">DOT {{ p.dot || '‚Äî' }}</span>
              </div>
            </td>

            <td>
              <div class="stack">
                <span class="pill" [ngClass]="statusClass(p.status)">{{ p.status }}</span>
                <span class="pill pill-alert" *ngIf="isAlerta(p)">{{ getAlertaLabel(p) }}</span>
              </div>
            </td>

            <td class="truncate">
              <div class="stack">
                <span class="strong">{{ p.caminhaoAtual?.placa || '‚Äî' }}</span>
                <span class="muted">{{ p.posicaoAtual || '‚Äî' }}</span>
              </div>
            </td>

            <td style="min-width: 220px;">
              <div class="progress-wrapper">
                <div class="progress-info">
                  <span class="mono">{{ p.kmAtual || 0 }} km</span>
                  <span class="mono">{{ p.vidaPrevistaKm || 0 }} km</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="progressoVida(p)"></div>
                </div>
              </div>
            </td>

            <td class="mono">
              {{ p.profundidadeMm != null ? (p.profundidadeMm | number:'1.1-1') + ' mm' : '‚Äî' }}
            </td>

            <td class="mono">{{ p.recapagens || 0 }}</td>

            <td class="num mono">
              {{ (p.custoTotal || p.custoAquisicao || 0) | currency:'BRL' }}
            </td>

            <td class="actions" (click)="$event.stopPropagation()">
              <button class="icon-btn edit" type="button" title="Editar cadastro" (click)="openEditarCadastro(p)">
                <i class="fas fa-pen"></i>
              </button>

              <button class="icon-btn" type="button" title="Movimentar pneu" (click)="openMovimentar(p)">
                <i class="fas fa-exchange-alt"></i>
              </button>

              <button class="icon-btn danger" type="button" title="Excluir" (click)="excluir(p.id)">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>

          <!-- EXPAND: detalhes ricos -->
          <tr class="expand-row" *ngIf="expandedId === p.id">
            <td colspan="11" class="expand-cell">
              <div class="expand-grid">

                <div class="kv">
                  <div class="k">√öltima movimenta√ß√£o</div>
                  <div class="v">{{ p.dtUltMov ? (p.dtUltMov | date:'dd/MM/yy HH:mm') : '‚Äî' }}</div>
                </div>

                <div class="kv">
                  <div class="k">Cadastro</div>
                  <div class="v">{{ p.dtCadastro | date:'dd/MM/yy HH:mm' }}</div>
                </div>

                <div class="kv">
                  <div class="k">Km instala√ß√£o</div>
                  <div class="v">{{ p.kmInstalacao ?? '‚Äî' }}</div>
                </div>

                <div class="kv">
                  <div class="k">Vida prevista (km)</div>
                  <div class="v mono">{{ p.vidaPrevistaKm || 0 }}</div>
                </div>

                <div class="kv">
                  <div class="k">Km atual do pneu</div>
                  <div class="v mono">{{ p.kmAtual || 0 }}</div>
                </div>

                <div class="kv">
                  <div class="k">Alerta</div>
                  <div class="v">
                    <span *ngIf="isAlerta(p)" class="pill pill-alert">{{ getAlertaLabel(p) }}</span>
                    <span *ngIf="!isAlerta(p)" class="muted">‚Äî</span>
                  </div>
                </div>

                <div class="kv">
                  <div class="k">Sulco atual / m√≠nimo</div>
                  <div class="v mono">
                    {{ p.profundidadeMm != null ? (p.profundidadeMm | number:'1.1-1') : '‚Äî' }}
                    /
                    {{ p.profundidadeMinMm != null ? (p.profundidadeMinMm | number:'1.1-1') : '‚Äî' }} mm
                  </div>
                </div>

                <div class="kv">
                  <div class="k">Custo aquisi√ß√£o</div>
                  <div class="v">{{ (p.custoAquisicao || 0) | currency:'BRL' }}</div>
                </div>

                <div class="kv">
                  <div class="k">Custo total (com recapagens)</div>
                  <div class="v">{{ (p.custoTotal || p.custoAquisicao || 0) | currency:'BRL' }}</div>
                </div>

                <div class="kv span2">
                  <div class="k">Observa√ß√£o</div>
                  <div class="v">{{ p.observacao || '‚Äî' }}</div>
                </div>

                <div class="kv span2">
                  <div class="k">Hist√≥rico de movimenta√ß√µes (mais recente primeiro)</div>

                  <div class="v" *ngIf="(p.historico?.length || 0) > 0; else semHist">
                    <div class="hist-item" *ngFor="let h of p.historico">
                      <div class="hist-top">
                        <span class="pill pill-type">{{ h.acao }}</span>
                        <span class="muted">{{ h.dt | date:'dd/MM/yy HH:mm' }}</span>
                      </div>

                      <div class="hist-body">
                        <div class="hist-col">
                          <div class="muted">Antes</div>
                          <div class="mono">{{ h.caminhaoAntes || '‚Äî' }} / {{ h.posicaoAntes || '‚Äî' }}</div>
                        </div>

                        <div class="hist-col">
                          <div class="muted">Depois</div>
                          <div class="mono">{{ h.caminhaoDepois || '‚Äî' }} / {{ h.posicaoDepois || '‚Äî' }}</div>
                        </div>

                        <div class="hist-col">
                          <div class="muted">Km</div>
                          <div class="mono">{{ h.kmDepois ?? h.kmAntes ?? '‚Äî' }}</div>
                        </div>
                      </div>

                      <div class="muted" *ngIf="h.observacao">{{ h.observacao }}</div>
                    </div>
                  </div>

                  <ng-template #semHist>
                    <span class="muted">‚Äî</span>
                  </ng-template>
                </div>

              </div>
            </td>
          </tr>

        </ng-container>

        <tr *ngIf="pneusFiltrados.length === 0">
          <td colspan="11" class="empty">Nenhum pneu encontrado.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL CADASTRO -->
  <div class="modal-overlay" *ngIf="showCadastro" (click)="closeCadastro()">
    <div class="modal-card" (click)="$event.stopPropagation()">

      <div class="modal-head">
        <h3>{{ cadastroEditing ? 'Editar Pneu' : 'Cadastrar Pneu' }}</h3>
      </div>

      <form class="modal-form" (ngSubmit)="salvarCadastro()">

        <div class="form-row">
          <div>
            <label>C√≥digo</label>
            <input type="text" [(ngModel)]="formCad.codigo" name="codigo" required />
          </div>

          <div>
            <label>Fogo (obrigat√≥rio)</label>
            <input type="text" [(ngModel)]="formCad.fogo" name="fogo" required />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>S√©rie</label>
            <input type="text" [(ngModel)]="formCad.serie" name="serie" />
          </div>

          <div>
            <label>Status</label>
            <select [(ngModel)]="formCad.status" name="status">
              <option value="ESTOQUE">ESTOQUE</option>
              <option value="EM_USO">EM_USO</option>
              <option value="RECAPAGEM">RECAPAGEM</option>
              <option value="DESCARTE">DESCARTE</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Marca</label>
            <input type="text" [(ngModel)]="formCad.marca" name="marca" />
          </div>

          <div>
            <label>Modelo</label>
            <input type="text" [(ngModel)]="formCad.modelo" name="modelo" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Medida</label>
            <input type="text" [(ngModel)]="formCad.medida" name="medida" />
          </div>

          <div>
            <label>DOT</label>
            <input type="text" [(ngModel)]="formCad.dot" name="dot" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Vida prevista (km)</label>
            <input type="number" [(ngModel)]="formCad.vidaPrevistaKm" name="vidaPrevistaKm" />
          </div>

          <div>
            <label>Km atual do pneu</label>
            <input type="number" [(ngModel)]="formCad.kmAtual" name="kmAtual" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Sulco atual (mm)</label>
            <input type="number" step="0.1" [(ngModel)]="formCad.profundidadeMm" name="profundidadeMm" />
          </div>

          <div>
            <label>Sulco m√≠nimo (mm)</label>
            <input type="number" step="0.1" [(ngModel)]="formCad.profundidadeMinMm" name="profundidadeMinMm" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Recapagens</label>
            <input type="number" [(ngModel)]="formCad.recapagens" name="recapagens" />
          </div>

          <div>
            <label>Custo aquisi√ß√£o</label>
            <input type="number" step="0.01" [(ngModel)]="formCad.custoAquisicao" name="custoAquisicao" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Custo total (opcional)</label>
            <input type="number" step="0.01" [(ngModel)]="formCad.custoTotal" name="custoTotal" />
          </div>

          <div>
            <label>Observa√ß√£o</label>
            <input type="text" [(ngModel)]="formCad.observacao" name="observacao" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" type="button" (click)="closeCadastro()">Cancelar</button>
          <button class="btn-save" type="submit">{{ cadastroEditing ? 'Salvar' : 'Cadastrar' }}</button>
        </div>

      </form>
    </div>
  </div>

  <!-- MODAL MOVIMENTA√á√ÉO -->
  <div class="modal-overlay" *ngIf="showMov" (click)="closeMovimentar()">
    <div class="modal-card" (click)="$event.stopPropagation()">

      <div class="modal-head">
        <h3>Movimentar Pneu</h3>
      </div>

      <form class="modal-form" (ngSubmit)="aplicarMovimentacao()">

        <div class="form-row">
          <div>
            <label>A√ß√£o</label>
            <select [(ngModel)]="formMov.acao" name="acao">
              <option value="INSTALADO">INSTALADO</option>
              <option value="REMOVIDO">REMOVIDO (para estoque)</option>
              <option value="TROCA_POSICAO">TROCA_POSICAO</option>
              <option value="ENVIADO_RECAPAGEM">ENVIADO_RECAPAGEM</option>
              <option value="RETORNO_RECAPAGEM">RETORNO_RECAPAGEM</option>
              <option value="DESCARTE">DESCARTE</option>
            </select>
          </div>

          <div>
            <label>Km do caminh√£o (opcional)</label>
            <input type="number" [(ngModel)]="formMov.kmCaminhao" name="kmCaminhao" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Caminh√£o</label>
            <select [(ngModel)]="formMov.caminhaoId" name="caminhaoId">
              <option value="">‚Äî</option>
              <option *ngFor="let c of caminhoes" [value]="c.id">{{ c.placa }} - {{ c.modelo }}</option>
            </select>
          </div>

          <div>
            <label>Posi√ß√£o</label>
            <select [(ngModel)]="formMov.posicao" name="posicao">
              <option value="">‚Äî</option>
              <option *ngFor="let p of posicoes" [value]="p">{{ p }}</option>
            </select>
          </div>
        </div>

        <div>
          <label>Observa√ß√£o</label>
          <input type="text" [(ngModel)]="formMov.observacao" name="observacao" placeholder="Opcional..." />
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" type="button" (click)="closeMovimentar()">Cancelar</button>
          <button class="btn-save" type="submit">Aplicar</button>
        </div>

      </form>
    </div>
  </div>

</div>
