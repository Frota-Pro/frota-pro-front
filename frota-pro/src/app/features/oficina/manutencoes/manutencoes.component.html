<div class="page">

  <div class="header">
    <div>
      <h1>Manuten√ß√µes</h1>
      <p>Registre OS, itens (pe√ßas/servi√ßos) e acompanhe status.</p>
    </div>

    <div class="actions">
      <button class="btn primary" type="button" (click)="openNovaManutencao()">+ Nova manuten√ß√£o</button>
    </div>
  </div>

  <div class="toolbar">
    <input class="search"
           [(ngModel)]="search"
           (ngModelChange)="scheduleBuscar()"
           placeholder="Buscar por c√≥digo, descri√ß√£o, caminh√£o, oficina, carga..." />

    <input class="search"
           style="min-width:220px; flex:0;"
           [(ngModel)]="caminhaoFilter"
           (ngModelChange)="applyLocalFilter()"
           placeholder="Filtro caminh√£o (c√≥d/placa)" />

    <select [(ngModel)]="statusFilter" class="select" (change)="applyLocalFilter()">
      <option [ngValue]="''">Status (todos)</option>
      <option [ngValue]="'ABERTA'">ABERTA</option>
      <option [ngValue]="'EM_ANDAMENTO'">EM ANDAMENTO</option>
      <option [ngValue]="'FINALIZADA'">FINALIZADA</option>
      <option [ngValue]="'CANCELADA'">CANCELADA</option>
    </select>

    <select [(ngModel)]="tipoFilter" class="select" (change)="applyLocalFilter()">
      <option [ngValue]="''">Tipo (todos)</option>
      <option [ngValue]="'PREVENTIVA'">PREVENTIVA</option>
      <option [ngValue]="'CORRETIVA'">CORRETIVA</option>
    </select>

    <div class="bulk">
      <input class="select" type="date" [(ngModel)]="dataInicio" (change)="applyLocalFilter()" />
      <input class="select" type="date" [(ngModel)]="dataFim" (change)="applyLocalFilter()" />
    </div>

    <button class="btn ghost" type="button" (click)="carregarPagina()">Atualizar</button>
  </div>

  <div class="alert" *ngIf="errorMsg">{{ errorMsg }}</div>

  <div class="table-wrap" *ngIf="!loading; else loadingTpl">
    <table class="table" *ngIf="filtered.length > 0; else emptyTpl">
      <thead>
      <tr>
        <th>C√≥digo</th>
        <th>Descri√ß√£o</th>
        <th>Caminh√£o</th>
        <th>Oficina</th>
        <th>Tipo</th>
        <th>Status</th>
        <th>In√≠cio</th>
        <th>Fim</th>
        <th>Total</th>
        <th>Carga/Parada</th>
        <th class="col-actions">A√ß√µes</th>
      </tr>
      </thead>

      <tbody>
      <tr *ngFor="let m of filtered" (dblclick)="abrirDetalhe(m)">
        <td class="mono">{{ m.codigo }}</td>

        <td>
          <div class="stack">
            <strong>{{ m.descricao }}</strong>
            <small class="muted" *ngIf="m.codigoCaminhao">C√≥d Caminh√£o: {{ m.codigoCaminhao }}</small>
          </div>
        </td>

        <td>
          <div class="stack">
            <strong>{{ m.caminhao || '‚Äî' }}</strong>
            <small class="muted">{{ m.codigoCaminhao }}</small>
          </div>
        </td>

        <td>
          <div class="stack">
            <strong>{{ m.oficina || '‚Äî' }}</strong>
            <small class="muted" *ngIf="m.codigoOficina">{{ m.codigoOficina }}</small>
          </div>
        </td>

        <td><span class="tag">{{ m.tipoManutencao }}</span></td>

        <td>
            <span class="status"
                  [class.inactive]="m.statusManutencao === 'CANCELADA'">
              {{ m.statusManutencao }}
            </span>
        </td>

        <td class="mono">{{ m._inicio || '‚Äî' }}</td>
        <td class="mono">{{ m._fim || '‚Äî' }}</td>

        <td class="mono">{{ formatMoneyBRL(m.valor) }}</td>

        <td>
          <div class="stack">
            <strong>{{ m.parada?.numeroCarga || '‚Äî' }}</strong>
            <small class="muted" *ngIf="m.parada?.id">Parada: {{ m.parada?.id }}</small>
          </div>
        </td>

        <td class="row-actions" (click)="$event.stopPropagation()">
          <button class="btn small" type="button" (click)="abrirDetalhe(m)">Ver</button>
          <button class="btn small" type="button" (click)="openEditar(m)">Editar</button>
          <button class="btn small danger" type="button" (click)="deletar(m)">Excluir</button>
        </td>
      </tr>
      </tbody>
    </table>

    <ng-template #emptyTpl>
      <div class="empty">
        <div class="icon">üß∞</div>
        <h3>Nenhuma manuten√ß√£o encontrada</h3>
        <p>Cadastre uma manuten√ß√£o ou ajuste os filtros.</p>
      </div>
    </ng-template>

    <div class="pagination" *ngIf="totalPages > 0">
      <button class="btn small" [disabled]="page<=0" (click)="carregarPagina(page-1)">Anterior</button>
      <span class="pageinfo">P√°gina {{ page + 1 }} de {{ totalPages }}</span>
      <button class="btn small" [disabled]="page+1>=totalPages" (click)="carregarPagina(page+1)">Pr√≥xima</button>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">
      <div class="spinner"></div>
      <div>Carregando manuten√ß√µes...</div>
    </div>
  </ng-template>

  <!-- MODAL -->
  <div class="backdrop" *ngIf="showModal" (click)="closeModal()"></div>

  <div class="modal" *ngIf="showModal">
    <div class="modal-header">
      <h2>{{ isEditing ? 'Editar manuten√ß√£o' : 'Nova manuten√ß√£o' }}</h2>
      <button class="icon" type="button" (click)="closeModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <label>Descri√ß√£o</label>
      <input [(ngModel)]="form.descricao" placeholder="Ex.: Troca de √≥leo, freio, etc." />

      <div class="row">
        <div class="col">
          <label>Data in√≠cio</label>
          <input type="date" [(ngModel)]="form.dataInicioManutencao" />
        </div>
        <div class="col">
          <label>Data fim</label>
          <input type="date" [(ngModel)]="form.dataFimManutencao" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Caminh√£o (c√≥digo ou externo)</label>
          <input [(ngModel)]="form.caminhao" placeholder="CAM-000001" />
        </div>
        <div class="col">
          <label>Oficina (c√≥digo)</label>
          <input [(ngModel)]="form.oficina" placeholder="OFI-000001 (opcional)" />
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Tipo</label>
          <select [(ngModel)]="form.tipoManutencao">
            <option value="CORRETIVA">CORRETIVA</option>
            <option value="PREVENTIVA">PREVENTIVA</option>
          </select>
        </div>
        <div class="col">
          <label>Status</label>
          <select [(ngModel)]="form.statusManutencao">
            <option value="ABERTA">ABERTA</option>
            <option value="EM_ANDAMENTO">EM ANDAMENTO</option>
            <option value="FINALIZADA">FINALIZADA</option>
            <option value="CANCELADA">CANCELADA</option>
          </select>
        </div>
      </div>

      <label>Parada (UUID)</label>
      <input [(ngModel)]="form.paradaId" placeholder="Opcional (UUID da parada)" />

      <label>Observa√ß√µes</label>
      <input [(ngModel)]="form.observacoes" placeholder="Opcional" />

      <div class="divider"></div>

      <div class="items-head">
        <strong>Itens (pe√ßas/servi√ßos)</strong>
        <button class="btn small" type="button" (click)="addItem()">+ Item</button>
      </div>

      <div class="item-row" *ngFor="let it of form.itens; let i = index">
        <select class="select" style="width:140px" [(ngModel)]="it.tipo" (change)="onItemChange()">
          <option value="SERVICO">SERVI√áO</option>
          <option value="PECA">PE√áA</option>
        </select>

        <input style="flex:1" [(ngModel)]="it.descricao" (ngModelChange)="onItemChange()" placeholder="Descri√ß√£o do item" />

        <input style="width:110px" type="number" [(ngModel)]="it.quantidade" (ngModelChange)="onItemChange()" placeholder="Qtd" />

        <input style="width:140px" type="number" [(ngModel)]="it.valorUnitario" (ngModelChange)="onItemChange()" placeholder="Valor unit." />

        <button class="btn small danger" type="button" (click)="removeItem(i)">‚Äì</button>
      </div>

      <div class="total">
        <span class="muted">Total calculado</span>
        <strong class="mono">{{ formatMoneyBRL(form.valor) }}</strong>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn" type="button" (click)="closeModal()">Cancelar</button>
      <button class="btn primary" type="button" (click)="salvar()">
        {{ isEditing ? 'Salvar' : 'Criar' }}
      </button>
    </div>
  </div>

</div>
