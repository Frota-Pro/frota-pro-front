<div class="page">

  <!-- Cabeçalho -->
  <div class="page-head">
    <div class="titles">
      <h2 class="page-title">Manutenções</h2>
      <p class="subtitle">Controle de OS, serviços e custos da frota</p>
    </div>

    <div class="actions">
      <button class="btn-add" type="button" (click)="openAddModal()">
        <i class="fas fa-plus"></i>
        Nova Manutenção
      </button>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-row">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      placeholder="Buscar por OS, placa, oficina, serviço..."
    />

    <select [(ngModel)]="filtroStatus">
      <option value="">Todos status</option>
      <option value="ABERTA">ABERTA</option>
      <option value="EM_ANDAMENTO">EM ANDAMENTO</option>
      <option value="FINALIZADA">FINALIZADA</option>
      <option value="CANCELADA">CANCELADA</option>
    </select>

    <select [(ngModel)]="filtroTipo">
      <option value="">Todos tipos</option>
      <option value="PREVENTIVA">PREVENTIVA</option>
      <option value="CORRETIVA">CORRETIVA</option>
    </select>

    <div class="date-inline">
      <span>De</span>
      <input type="date" [(ngModel)]="filtroDataInicio" />
    </div>

    <div class="date-inline">
      <span>Até</span>
      <input type="date" [(ngModel)]="filtroDataFim" />
    </div>
  </div>

  <!-- Tabela -->
  <div class="card">
    <div class="table-wrap">
      <table class="table">
        <thead>
        <tr>
          <th>OS</th>
          <th>Caminhão</th>
          <th>Oficina</th>
          <th>Tipo</th>
          <th>Status</th>
          <th>Aberta em</th>
          <th>Previsão</th>
          <th class="num">Valor</th>
          <th class="actions-col">Ações</th>
        </tr>
        </thead>

        <tbody>
        <ng-container *ngFor="let m of manutencoesFiltradas; trackBy: trackById">
          <tr class="row-click" (click)="toggleExpand(m.id)">
            <td class="strong mono">{{ m.os }}</td>
            <td class="truncate">{{ m.caminhao.placa }}</td>
            <td class="truncate">{{ m.oficina?.nome || '—' }}</td>
            <td><span class="pill pill-type">{{ m.tipo }}</span></td>

            <td>
                <span class="pill" [ngClass]="statusClass(m.status)">
                  {{ m.status }}
                </span>
            </td>

            <td>{{ m.dtAbertura | date:'dd/MM/yy HH:mm' }}</td>
            <td>{{ m.dtPrevisao ? (m.dtPrevisao | date:'dd/MM/yy HH:mm') : '—' }}</td>

            <td class="num">{{ (m.valorTotal || 0) | currency:'BRL' }}</td>

            <td class="actions" (click)="$event.stopPropagation()">
              <button class="icon-btn edit" type="button" title="Editar" (click)="openEditModal(m)">
                <i class="fas fa-pen"></i>
              </button>

              <button
                class="icon-btn success"
                type="button"
                title="Finalizar"
                *ngIf="(m.status || '').toUpperCase() !== 'FINALIZADA'"
                (click)="finalizar(m)"
              >
                <i class="fas fa-check"></i>
              </button>

              <button class="icon-btn danger" type="button" title="Excluir" (click)="excluir(m.id)">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>

          <!-- Expand -->
          <tr class="expand-row" *ngIf="expandedId === m.id">
            <td colspan="9" class="expand-cell">
              <div class="expand-grid">

                <div class="kv">
                  <div class="k">Km Entrada</div>
                  <div class="v">{{ m.kmEntrada ?? '—' }}</div>
                </div>

                <div class="kv">
                  <div class="k">Km Saída</div>
                  <div class="v">{{ m.kmSaida ?? '—' }}</div>
                </div>

                <div class="kv">
                  <div class="k">Fechamento</div>
                  <div class="v">{{ m.dtFechamento ? (m.dtFechamento | date:'dd/MM/yy HH:mm') : '—' }}</div>
                </div>

                <div class="kv span2">
                  <div class="k">Serviços</div>
                  <div class="v">
                    <ul class="chips" *ngIf="(m.servicos?.length || 0) > 0; else semServicos">
                      <li class="chip" *ngFor="let s of m.servicos">{{ s }}</li>
                    </ul>
                    <ng-template #semServicos><span class="muted">—</span></ng-template>
                  </div>
                </div>

                <div class="kv span2">
                  <div class="k">Peças</div>
                  <div class="v">
                    <div *ngIf="(m.pecas?.length || 0) > 0; else semPecas">
                      <div class="peca" *ngFor="let p of m.pecas">
                        <span class="truncate">{{ p.descricao }}</span>
                        <span class="mono">x{{ p.qtd }}</span>
                        <span class="mono">{{ (p.valor || 0) | currency:'BRL' }}</span>
                      </div>
                    </div>
                    <ng-template #semPecas><span class="muted">—</span></ng-template>
                  </div>
                </div>

                <div class="kv span2">
                  <div class="k">Observação</div>
                  <div class="v">{{ m.observacao || '—' }}</div>
                </div>

              </div>
            </td>
          </tr>
        </ng-container>

        <tr *ngIf="manutencoesFiltradas.length === 0">
          <td colspan="9" class="empty">Nenhuma manutenção encontrada.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
    <div class="modal-card" (click)="$event.stopPropagation()">

      <div class="modal-head">
        <h3>{{ isEditing ? 'Editar Manutenção' : 'Nova Manutenção' }}</h3>
      </div>

      <form class="modal-form" (ngSubmit)="save()">

        <div class="form-row">
          <div>
            <label>OS</label>
            <input type="text" [(ngModel)]="form.os" name="os" required />
          </div>

          <div>
            <label>Status</label>
            <select [(ngModel)]="form.status" name="status">
              <option value="ABERTA">ABERTA</option>
              <option value="EM_ANDAMENTO">EM ANDAMENTO</option>
              <option value="FINALIZADA">FINALIZADA</option>
              <option value="CANCELADA">CANCELADA</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Caminhão</label>
            <select [(ngModel)]="form.caminhaoId" name="caminhaoId" required>
              <option value="">Selecione...</option>
              <option *ngFor="let c of caminhoes" [value]="c.id">{{ c.placa }} - {{ c.modelo }}</option>
            </select>
          </div>

          <div>
            <label>Oficina</label>
            <select [(ngModel)]="form.oficinaId" name="oficinaId">
              <option value="">—</option>
              <option *ngFor="let o of oficinas" [value]="o.id">{{ o.nome }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Tipo</label>
            <select [(ngModel)]="form.tipo" name="tipo">
              <option value="CORRETIVA">CORRETIVA</option>
              <option value="PREVENTIVA">PREVENTIVA</option>
            </select>
          </div>

          <div>
            <label>Data Abertura</label>
            <input type="datetime-local" [(ngModel)]="form.dtAbertura" name="dtAbertura" required />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Previsão</label>
            <input type="datetime-local" [(ngModel)]="form.dtPrevisao" name="dtPrevisao" />
          </div>

          <div>
            <label>Fechamento</label>
            <input type="datetime-local" [(ngModel)]="form.dtFechamento" name="dtFechamento" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Km Entrada</label>
            <input type="number" [(ngModel)]="form.kmEntrada" name="kmEntrada" />
          </div>

          <div>
            <label>Km Saída</label>
            <input type="number" [(ngModel)]="form.kmSaida" name="kmSaida" />
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Valor Total</label>
            <input type="number" step="0.01" [(ngModel)]="form.valorTotal" name="valorTotal" />
          </div>

          <div>
            <label>Serviços (1 por linha)</label>
            <textarea rows="4" [(ngModel)]="form.servicosText" name="servicosText"
                      placeholder="Ex: Troca de óleo&#10;Revisão freios"></textarea>
          </div>
        </div>

        <div class="form-row">
          <div>
            <label>Peças (linha: descricao;qtd;valor)</label>
            <textarea rows="4" [(ngModel)]="form.pecasText" name="pecasText"
                      placeholder="Ex: Filtro de óleo;1;45&#10;Óleo 15w40;3;35"></textarea>
          </div>

          <div>
            <label>Observação</label>
            <textarea rows="4" [(ngModel)]="form.observacao" name="observacao"
                      placeholder="Opcional..."></textarea>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" type="button" (click)="closeModal()">Cancelar</button>
          <button class="btn-save" type="submit">{{ isEditing ? 'Salvar' : 'Cadastrar' }}</button>
        </div>

      </form>
    </div>
  </div>

</div>
