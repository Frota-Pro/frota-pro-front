<div class="page">

  <!-- Header -->
  <div class="page-head">
    <div class="titles">
      <h2 class="page-title">Logs do Sistema</h2>
      <p class="subtitle">Visualize registros e eventos do sistema</p>
    </div>

    <div class="actions">
      <button class="btn-ghost" type="button" (click)="refresh()">
        <i class="fas fa-rotate"></i>
        Atualizar
      </button>
    </div>
  </div>

  <!-- Search row -->
  <div class="search-row">
    <div class="search">
      <i class="fas fa-search"></i>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        placeholder="Buscar por mensagem ou correlation ID..."
      />
    </div>

    <select [(ngModel)]="filtroNivel">
      <option value="">Todos</option>
      <option value="INFO">Info</option>
      <option value="WARNING">Warning</option>
      <option value="ERROR">Error</option>
    </select>

    <select [(ngModel)]="filtroPeriodo">
      <option value="24H">Últimas 24h</option>
      <option value="7D">Últimos 7 dias</option>
      <option value="30D">Últimos 30 dias</option>
    </select>
  </div>

  <!-- KPIs -->
  <div class="cards-row">
    <div class="kpi-card">
      <div class="kpi-ico gray"><i class="far fa-file-alt"></i></div>
      <div class="kpi-info">
        <div class="kpi-value">{{ totalLogs }}</div>
        <div class="kpi-label">Total de Logs</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-ico blue"><i class="fas fa-info"></i></div>
      <div class="kpi-info">
        <div class="kpi-value">{{ totalInfo }}</div>
        <div class="kpi-label">Info</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-ico amber"><i class="fas fa-triangle-exclamation"></i></div>
      <div class="kpi-info">
        <div class="kpi-value">{{ totalWarn }}</div>
        <div class="kpi-label">Warning</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-ico red"><i class="fas fa-bug"></i></div>
      <div class="kpi-info">
        <div class="kpi-value">{{ totalError }}</div>
        <div class="kpi-label">Error</div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="card-head">
      <div class="h">Registros</div>
    </div>

    <div class="table-wrap">
      <table class="table">
        <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Nível</th>
          <th>Mensagem</th>
          <th class="right">Correlation ID</th>
        </tr>
        </thead>

        <tbody>
        <tr
          *ngFor="let l of logsFiltrados; trackBy: trackById"
          (click)="openDetails(l)"
          class="row-click"
        >
          <td class="mono">{{ formatIso(l.timestamp) }}</td>

          <td>
            <span class="pill" [ngClass]="levelPillClass(l.level)">{{ l.level }}</span>
          </td>

          <td class="truncate">
            <span class="msg">{{ l.message }}</span>
            <span class="meta" *ngIf="l.origin || l.module">
                • {{ l.origin || '—' }} / {{ l.module || '—' }}
              </span>
          </td>

          <td class="right">
            <span class="cid mono">{{ l.correlationId || '—' }}</span>
          </td>
        </tr>

        <tr *ngIf="logsFiltrados.length === 0">
          <td colspan="4" class="empty">Nenhum log encontrado.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Drawer (detalhes) -->
  <div class="drawer-overlay" *ngIf="selected" (click)="closeDetails()">
    <aside class="drawer" (click)="$event.stopPropagation()">

      <div class="drawer-head">
        <div>
          <div class="drawer-title">Detalhes do Log</div>
          <div class="drawer-sub">
            {{ selected?.timestamp ? formatIso(selected!.timestamp) : '' }}
          </div>
        </div>

        <button class="icon-close" type="button" (click)="closeDetails()">
          <i class="fas fa-xmark"></i>
        </button>
      </div>

      <div class="drawer-body">
        <div class="grid2">
          <div class="box">
            <div class="lbl">Nível</div>
            <div>
              <span class="pill" [ngClass]="levelPillClass(selected!.level)">{{ selected!.level }}</span>
            </div>
          </div>

          <div class="box">
            <div class="lbl">Correlation ID</div>
            <div class="row">
              <span class="mono">{{ selected!.correlationId || '—' }}</span>
              <button class="mini" type="button" (click)="copy(selected!.correlationId)">
                <i class="far fa-copy"></i>
              </button>
            </div>
          </div>

          <div class="box">
            <div class="lbl">Origem</div>
            <div>{{ selected!.origin || '—' }}</div>
          </div>

          <div class="box">
            <div class="lbl">Módulo</div>
            <div>{{ selected!.module || '—' }}</div>
          </div>
        </div>

        <div class="box">
          <div class="lbl">Mensagem</div>
          <div class="message">{{ selected!.message }}</div>
        </div>

        <div class="grid3">
          <div class="box">
            <div class="lbl">Usuário</div>
            <div class="mono">{{ selected!.userEmail || '—' }}</div>
          </div>

          <div class="box">
            <div class="lbl">HTTP</div>
            <div class="mono">
              {{ selected!.method || '—' }} {{ selected!.path || '' }}
            </div>
          </div>

          <div class="box">
            <div class="lbl">Status / Duração</div>
            <div class="mono">
              {{ selected!.statusCode ?? '—' }} • {{ selected!.durationMs ?? '—' }}ms
            </div>
          </div>
        </div>

        <div class="box" *ngIf="selected!.payload">
          <div class="lbl">Payload</div>
          <pre class="code">{{ selected!.payload }}</pre>
        </div>

        <div class="box" *ngIf="selected!.stacktrace">
          <div class="lbl">Stacktrace</div>
          <pre class="code">{{ selected!.stacktrace }}</pre>
        </div>

      </div>
    </aside>
  </div>

</div>
