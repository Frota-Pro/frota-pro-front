<div class="abaste-page">

  <!-- Cabe√ßalho -->
  <div class="page-head">
    <div class="titles">
      <h2 class="page-title">Abastecimentos</h2>
      <p class="subtitle">Controle de combust√≠vel da frota</p>
    </div>

    <div class="actions">
      <button class="btn-add" type="button" (click)="openAddModal()">
        <i class="fas fa-plus"></i>
        Adicionar Abastecimento
      </button>
    </div>
  </div>

  <!-- Cards KPI -->
  <div class="cards-row">
    <div class="card">
      <div class="card-icon">‚õΩ</div>
      <div class="card-info">
        <div class="card-title">{{ (filtroDataInicio || filtroDataFim) ? 'Litros (per√≠odo)' : 'Litros (m√™s)' }}</div>
        <div class="card-value">{{ litersThisMonth | number : '1.0-3' }}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-icon">üíµ</div>
      <div class="card-info">
        <div class="card-title">Gasto total</div>
        <div class="card-value">{{ totalSpent | currency : 'BRL' }}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-icon">‚öñÔ∏è</div>
      <div class="card-info">
        <div class="card-title">Pre√ßo m√©dio (R$/L)</div>
        <div class="card-value">{{ avgPricePerLiter | number : '1.2-3' }}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-icon">üöö</div>
      <div class="card-info">
        <div class="card-title">Consumo m√©dio (km/L)</div>
        <div class="card-value">{{ avgConsumption | number : '1.2-2' }}</div>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-row">
    <input
      type="text"
      [(ngModel)]="searchTerm"
      (ngModelChange)="scheduleBuscar()"
      placeholder="Pesquisar geral..."
    />

    <select [(ngModel)]="filtroTipo" (ngModelChange)="scheduleBuscar()">
      <option value="">Todos combust√≠veis</option>
      <option *ngFor="let c of combustiveis" [value]="c">{{ c }}</option>
    </select>

    <input
      type="text"
      [(ngModel)]="filtroCaminhao"
      (ngModelChange)="scheduleBuscar()"
      placeholder="Filtrar por caminh√£o (placa/c√≥digo)"
    />

    <input
      type="text"
      [(ngModel)]="filtroMotorista"
      (ngModelChange)="scheduleBuscar()"
      placeholder="Filtrar por motorista"
    />

    <div class="date-inline">
      <span>De</span>
      <input type="date" [(ngModel)]="filtroDataInicio" (ngModelChange)="scheduleBuscar()" />
    </div>

    <div class="date-inline">
      <span>At√©</span>
      <input type="date" [(ngModel)]="filtroDataFim" (ngModelChange)="scheduleBuscar()" />
    </div>
  </div>

  <!-- Lista -->
  <div class="list-block">
    <div class="block-header">
      <h3>Abastecimentos</h3>
      <span class="count">{{ abastecimentosFiltrados.length || 0 }}</span>
    </div>

    <div class="list-header">
      <span>Data</span>
      <span>Caminh√£o</span>
      <span>Motorista</span>
      <span>Combust√≠vel</span>
      <span>Litros</span>
      <span>Valor</span>
      <span>Posto</span>
      <span style="text-align:right;">A√ß√µes</span>
    </div>

    <ul class="abaste-list">
      <li class="abaste-item" *ngFor="let a of abastecimentosFiltrados; trackBy: trackById">

        <div class="row" (click)="toggleExpand(a.id)">
          <span>{{ a.dtAbastecimento | date : 'dd/MM/yyyy HH:mm' }}</span>

          <span class="mono">{{ a.caminhao.placa || a.caminhao.codigo || '‚Äî' }}</span>

          <span class="truncate">{{ a.motorista?.nome || '‚Äî' }}</span>

          <span>
            <span class="pill pill-fuel">{{ a.tipoCombustivel || '‚Äî' }}</span>
          </span>

          <span class="num">{{ a.qtLitros || 0 | number : '1.0-3' }}</span>

          <span class="num">{{ a.valorTotal || 0 | currency : 'BRL' }}</span>

          <span class="truncate">{{ a.posto || '‚Äî' }}</span>

          <div class="row-actions">
            <button
              class="icon-btn edit"
              type="button"
              title="Editar"
              (click)="openEditModal(a); $event.stopPropagation()"
            >
              <i class="fas fa-pen"></i>
            </button>

            <button
              class="icon-btn danger"
              type="button"
              title="Excluir"
              (click)="deleteAbastecimento(a.id); $event.stopPropagation()"
            >
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="expand-container" [class.expanded]="isExpanded(a.id)">
          <div class="details">
            <div><strong>C√≥digo:</strong> {{ a.codigo || '‚Äî' }}</div>
            <div><strong>Od√¥metro:</strong> {{ a.kmOdometro ?? '‚Äî' }}</div>

            <div><strong>Valor/L:</strong> {{ (a.valorLitro || 0) | currency : 'BRL' }}</div>
            <div><strong>Forma Pgto:</strong> {{ a.formaPagamento || '‚Äî' }}</div>

            <div><strong>Nota/Cupom:</strong> {{ a.numNotaOuCupom || '‚Äî' }}</div>
            <div><strong>M√©dia km/L:</strong> {{ a.mediaKmLitro ?? '‚Äî' }}</div>

            <div><strong>Cidade:</strong> {{ a.cidade || '‚Äî' }}</div>
            <div><strong>UF:</strong> {{ a.uf || '‚Äî' }}</div>
          </div>
        </div>

      </li>

      <li *ngIf="(abastecimentosFiltrados.length || 0) === 0" class="abaste-item">
        <div class="row" style="grid-template-columns: 1fr; text-align: center;">
          <span style="padding: 12px; color: rgba(15,23,42,0.55);">
            Nenhum abastecimento encontrado.
          </span>
        </div>
      </li>
    </ul>
  </div>

  <!-- ‚úÖ MODAL MELHORADO -->
  <div class="ab-modal-overlay" *ngIf="showAddModal" (click)="closeAddModal()">
    <div class="ab-modal" (click)="$event.stopPropagation()">

      <div class="ab-modal__header">
        <div class="ab-modal__title">
          <h3>{{ isEditing ? 'Editar Abastecimento' : 'Novo Abastecimento' }}</h3>
          <p>Registre os dados do abastecimento com precis√£o.</p>
        </div>
        <button class="ab-modal__close" type="button" (click)="closeAddModal()" aria-label="Fechar">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form class="ab-modal__body" (ngSubmit)="saveAbastecimento()">

        <!-- Se√ß√£o 1 -->
        <section class="ab-section">
          <div class="ab-section__head">
            <span class="ab-section__dot"></span>
            <div class="ab-section__texts">
              <div class="ab-section__title">Dados do abastecimento</div>
              <div class="ab-section__desc">Data, combust√≠vel, litros e od√¥metro.</div>
            </div>
          </div>

          <div class="ab-grid">
            <div class="ab-field">
              <label>C√≥digo</label>
              <input type="text" [(ngModel)]="novo.codigo" name="codigo" required />
            </div>

            <div class="ab-field">
              <label>Data/Hora</label>
              <input
                type="datetime-local"
                [(ngModel)]="novo.dtAbastecimento"
                name="dtAbastecimento"
                required
              />
            </div>

            <div class="ab-field">
              <label>Combust√≠vel</label>
              <select [(ngModel)]="novo.tipoCombustivel" name="tipoCombustivel" required>
                <option *ngFor="let c of combustiveis" [value]="c">{{ c }}</option>
              </select>
            </div>

            <div class="ab-field">
              <label>Litros</label>
              <input type="number" step="0.001" [(ngModel)]="novo.qtLitros" name="qtLitros" required />
            </div>

            <div class="ab-field">
              <label>Valor/L</label>
              <input type="number" step="0.001" [(ngModel)]="novo.valorLitro" name="valorLitro" required />
            </div>

            <div class="ab-field">
              <label>Od√¥metro (km)</label>
              <input type="number" [(ngModel)]="novo.kmOdometro" name="kmOdometro" />
              <small class="ab-hint">Ajuda a calcular o consumo m√©dio (km/L).</small>
            </div>

            <div class="ab-field">
              <label>M√©dia km/L (opcional)</label>
              <input type="number" step="0.01" [(ngModel)]="novo.mediaKmLitro" name="mediaKmLitro" />
              <small class="ab-hint">Se vazio, o sistema tenta calcular pelo od√¥metro.</small>
            </div>
          </div>
        </section>

        <!-- Se√ß√£o 2 -->
        <section class="ab-section">
          <div class="ab-section__head">
            <span class="ab-section__dot"></span>
            <div class="ab-section__texts">
              <div class="ab-section__title">Ve√≠culo e motorista</div>
              <div class="ab-section__desc">V√≠nculo do abastecimento ao caminh√£o.</div>
            </div>
          </div>

          <div class="ab-grid">
            <div class="ab-field">
              <label>Placa do Caminh√£o</label>
              <input type="text" [(ngModel)]="novo.caminhao.placa" name="placa" placeholder="Ex: ABC1D23" />
            </div>

            <div class="ab-field">
              <label>C√≥digo do Caminh√£o</label>
              <input type="text" [(ngModel)]="novo.caminhao.codigo" name="codigoCaminhao" placeholder="Ex: CAM-001" />
            </div>

            <div class="ab-field">
              <label>Motorista</label>
              <input type="text" [(ngModel)]="novo.motorista.nome" name="nomeMotorista" placeholder="Ex: Carlos Silva" />
            </div>
          </div>
        </section>

        <!-- Se√ß√£o 3 -->
        <section class="ab-section">
          <div class="ab-section__head">
            <span class="ab-section__dot"></span>
            <div class="ab-section__texts">
              <div class="ab-section__title">Pagamento e local</div>
              <div class="ab-section__desc">Posto, nota e localiza√ß√£o.</div>
            </div>
          </div>

          <div class="ab-grid">
            <div class="ab-field">
              <label>Posto</label>
              <input type="text" [(ngModel)]="novo.posto" name="posto" placeholder="Ex: Posto Central" />
            </div>

            <div class="ab-field">
              <label>Forma Pgto</label>
              <select [(ngModel)]="novo.formaPagamento" name="formaPagamento">
                <option value="">Selecione...</option>
                <option value="DINHEIRO">DINHEIRO</option>
                <option value="CARTAO">CART√ÉO</option>
                <option value="PIX">PIX</option>
                <option value="FATURADO">FATURADO</option>
              </select>
            </div>

            <div class="ab-field">
              <label>Nota/Cupom</label>
              <input type="text" [(ngModel)]="novo.numNotaOuCupom" name="numNotaOuCupom" placeholder="Ex: NF12345" />
            </div>

            <div class="ab-field">
              <label>Cidade</label>
              <input type="text" [(ngModel)]="novo.cidade" name="cidade" />
            </div>

            <div class="ab-field">
              <label>UF</label>
              <input type="text" [(ngModel)]="novo.uf" name="uf" maxlength="2" placeholder="Ex: PB" />
            </div>
          </div>
        </section>

        <!-- footer fixo -->
        <div class="ab-modal__footer">
          <button class="ab-btn ghost" type="button" (click)="closeAddModal()">Cancelar</button>
          <button class="ab-btn primary" type="submit">{{ isEditing ? 'Salvar' : 'Cadastrar' }}</button>
        </div>

      </form>
    </div>
  </div>

</div>
