<div class="page">
  <div class="header">
    <div>
      <h1>Relat√≥rios</h1>
      <p>Gere, visualize e baixe PDFs.</p>
    </div>

    <div class="header-actions">
      <button class="btn ghost" type="button" (click)="limparPreview()" [disabled]="!pdfSafeUrl">Limpar</button>
      <button class="btn primary" type="button" (click)="gerar()" [disabled]="loading">
        {{ loading ? 'Gerando...' : 'Gerar' }}
      </button>
    </div>
  </div>

  <div class="grid">
    <!-- filtros -->
    <section class="card">
      <h3>Filtros</h3>

      <div class="form">
        <div class="field">
          <label>Tipo</label>
          <select [(ngModel)]="form.tipo" (ngModelChange)="onTipoChange()">
            <option value="">Selecione...</option>
            <option *ngFor="let r of reports" [ngValue]="r.key" [disabled]="r.enabled === false">
              {{ r.title }}
            </option>
          </select>
        </div>

        <div class="field" *ngIf="selectedDef?.needsPeriodo">
          <label>In√≠cio</label>
          <input type="date" [(ngModel)]="form.inicio" />
        </div>

        <div class="field" *ngIf="selectedDef?.needsPeriodo">
          <label>Fim</label>
          <input type="date" [(ngModel)]="form.fim" />
        </div>

        <!-- ‚úÖ ABASTECIMENTOS: filtros opcionais -->
        <div class="field" *ngIf="form.tipo === 'ABASTECIMENTOS'">
          <label>Caminh√£o (opcional)</label>
          <input type="text" placeholder="Ex: CAM-000030" [(ngModel)]="form.codigoCaminhao" />
        </div>

        <div class="field" *ngIf="form.tipo === 'ABASTECIMENTOS'">
          <label>Motorista (opcional)</label>
          <input type="text" placeholder="Ex: MOT-000001" [(ngModel)]="form.codigoMotorista" />
        </div>

        <!-- üîí outros relat√≥rios: obrigat√≥rios quando o tipo exigir -->
        <div class="field" *ngIf="selectedDef?.needsCaminhao && form.tipo !== 'ABASTECIMENTOS'">
          <label>Caminh√£o (c√≥digo)</label>
          <input type="text" placeholder="Ex: CAM-000030" [(ngModel)]="form.codigoCaminhao" />
        </div>

        <div class="field" *ngIf="selectedDef?.needsMotorista && form.tipo !== 'ABASTECIMENTOS'">
          <label>Motorista (c√≥digo)</label>
          <input type="text" placeholder="Ex: MOT-000001" [(ngModel)]="form.codigoMotorista" />
        </div>

        <div class="field" *ngIf="selectedDef?.needsNumeroCarga">
          <label>N√∫mero da Carga</label>
          <input type="text" placeholder="Ex: 000001" [(ngModel)]="form.numeroCarga" />
        </div>

        <div class="alert" *ngIf="errorMsg">
          {{ errorMsg }}
        </div>

        <div class="mini-actions">
          <button class="btn" type="button" (click)="abrirNovaAba()" [disabled]="!pdfSafeUrl">Abrir</button>
          <button class="btn success" type="button" (click)="baixar()" [disabled]="!pdfSafeUrl">Download</button>
        </div>
      </div>
    </section>

    <!-- preview -->
    <section class="card preview-card">
      <div class="preview-head">
        <h3>Pr√©-visualiza√ß√£o</h3>
        <span class="hint" *ngIf="lastFilename">{{ lastFilename }}</span>
      </div>

      <div class="preview-wrap" *ngIf="pdfSafeUrl; else empty">
        <iframe class="pdf-frame" [src]="pdfSafeUrl"></iframe>
      </div>

      <ng-template #empty>
        <div class="empty">
          Gere um relat√≥rio para visualizar aqui.
        </div>
      </ng-template>
    </section>
  </div>
</div>
