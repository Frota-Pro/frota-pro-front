<div class="page">

  <div class="header">
    <div>
      <h1>Caminh√µes</h1>
      <p>Selecione caminh√µes, crie categorias e vincule em lote.</p>
    </div>

    <div class="actions">
      <button class="btn ghost" type="button" (click)="openCategoriaModal()">+ Nova categoria</button>
      <button class="btn primary" type="button" (click)="openNovoCaminhao()">+ Novo caminh√£o</button>
    </div>
  </div>

  <div class="toolbar">
    <input class="search"
           [(ngModel)]="search"
           (keyup.enter)="page=0; carregarPagina()"
           placeholder="Buscar por placa, descri√ß√£o, marca, modelo, categoria..." />

    <select [(ngModel)]="ativoFilter" class="select">
      <option [ngValue]="'ATIVOS'">Ativos</option>
      <option [ngValue]="'INATIVOS'">Inativos</option>
      <option [ngValue]="'TODOS'">Todos</option>
    </select>

    <div class="bulk">
      <select [(ngModel)]="categoriaSelecionada" class="select">
        <option value="">Vincular categoria...</option>
        <option *ngFor="let c of categorias" [value]="c.codigo">{{ c.descricao }} ({{ c.codigo }})</option>
      </select>

      <button class="btn" type="button" (click)="aplicarCategoria()">
        Aplicar ({{ selected.size }})
      </button>
    </div>

    <button class="btn ghost" type="button" (click)="carregarPagina()">Atualizar</button>
  </div>

  <div class="alert" *ngIf="errorMsg">{{ errorMsg }}</div>

  <div class="table-wrap" *ngIf="!loading; else loadingTpl">
    <table class="table" *ngIf="filtered.length > 0; else emptyTpl">
      <thead>
      <tr>
        <th class="col-check">
          <input
            type="checkbox"
            (change)="toggleAll($any($event.target).checked)"
            [checked]="selected.size > 0 && selected.size === filtered.length"
          />
        </th>
        <th>C√≥digo</th>
        <th>Placa</th>
        <th>Descri√ß√£o</th>
        <th>Marca/Modelo</th>
        <th>Categoria</th>
        <th>Status</th>
        <th class="col-actions">A√ß√µes</th>
      </tr>
      </thead>

      <tbody>
      <tr *ngFor="let c of filtered" (dblclick)="abrirDetalhe(c)">
        <td class="col-check" (click)="$event.stopPropagation()">
          <input type="checkbox"
                 [checked]="isSelected(c.codigo)"
                 (change)="toggleOne(c.codigo, $any($event.target).checked)" />
        </td>

        <td class="mono">{{ c.codigo }}</td>
        <td class="plate">{{ c.placa }}</td>

        <td>
          <div class="stack">
            <strong>{{ c.descricao }}</strong>
            <small class="muted" *ngIf="c.codigoExterno">Ext: {{ c.codigoExterno }}</small>
          </div>
        </td>

        <td>
          <div class="stack">
            <strong>{{ c.marca }}</strong>
            <small class="muted">{{ c.modelo }}</small>
          </div>
        </td>

        <td>
          <span class="tag">{{ c.categoriaDescricao || '‚Äî' }}</span>
        </td>

        <td>
          <span class="status" [class.inactive]="!c.ativo">{{ c.ativo ? 'ATIVO' : 'INATIVO' }}</span>
        </td>

        <td class="row-actions" (click)="$event.stopPropagation()">
          <button class="btn small" type="button" (click)="abrirDetalhe(c)">Ver</button>

          <button *ngIf="c.ativo" class="btn small danger" type="button" (click)="inativar(c)">
            Inativar
          </button>

          <button *ngIf="!c.ativo" class="btn small" type="button" (click)="ativar(c)">
            Ativar
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <ng-template #emptyTpl>
      <div class="empty">
        <div class="icon">üöö</div>
        <h3>Nenhum caminh√£o encontrado</h3>
        <p>Cadastre um caminh√£o ou ajuste os filtros.</p>
      </div>
    </ng-template>

    <div class="pagination" *ngIf="totalPages > 0">
      <button class="btn ghost" (click)="prevPage()" [disabled]="page <= 0">‚óÄ</button>
      <div class="pageinfo">P√°gina {{ page + 1 }} de {{ totalPages }}</div>
      <button class="btn ghost" (click)="nextPage()" [disabled]="page + 1 >= totalPages">‚ñ∂</button>
    </div>
  </div>

  <ng-template #loadingTpl>
    <div class="loading">
      <div class="spinner"></div>
      <span>Carregando...</span>
    </div>
  </ng-template>

  <!-- MODAL CATEGORIA -->
  <div class="backdrop" *ngIf="showCategoriaModal" (click)="closeCategoriaModal()"></div>
  <div class="modal" *ngIf="showCategoriaModal">
    <div class="modal-header">
      <h2>Nova categoria</h2>
      <button class="icon" (click)="closeCategoriaModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <label>C√≥digo</label>
      <input [(ngModel)]="catForm.codigo" placeholder="Ex: CARRETA" />

      <label>Descri√ß√£o</label>
      <input [(ngModel)]="catForm.descricao" placeholder="Ex: Carreta" />

      <small class="muted">O c√≥digo √© o que ser√° enviado no caminh√£o: <span class="mono">categoria</span>.</small>
    </div>

    <div class="modal-footer">
      <button class="btn ghost" (click)="closeCategoriaModal()">Cancelar</button>
      <button class="btn primary" (click)="salvarCategoria()">Salvar</button>
    </div>
  </div>

  <!-- MODAL CAMINH√ÉO (simples) -->
  <div class="backdrop" *ngIf="showCaminhaoModal" (click)="closeCaminhaoModal()"></div>
  <div class="modal" *ngIf="showCaminhaoModal">
    <div class="modal-header">
      <h2>Novo caminh√£o</h2>
      <button class="icon" (click)="closeCaminhaoModal()">‚úï</button>
    </div>

    <div class="modal-body">
      <label>Descri√ß√£o</label>
      <input [(ngModel)]="form.descricao" placeholder="Ex: Caminh√£o Ba√∫" />

      <label>Marca</label>
      <input [(ngModel)]="form.marca" placeholder="Ex: Volvo" />

      <label>Modelo</label>
      <input [(ngModel)]="form.modelo" placeholder="Ex: FH 540" />

      <label>Placa</label>
      <input [(ngModel)]="form.placa" placeholder="Ex: ABC1D23" />

      <label>Categoria</label>
      <select [(ngModel)]="form.categoria">
        <option [ngValue]="null">‚Äî</option>
        <option *ngFor="let c of categorias" [ngValue]="c.codigo">{{ c.descricao }} ({{ c.codigo }})</option>
      </select>

      <label>Licenciamento (dd/MM/yyyy)</label>
      <input [(ngModel)]="form.dtLicenciamento" placeholder="Ex: 29/12/2025" />
    </div>

    <div class="modal-footer">
      <button class="btn ghost" (click)="closeCaminhaoModal()">Cancelar</button>
      <button class="btn primary" (click)="salvarCaminhao()">Salvar</button>
    </div>
  </div>
</div>
