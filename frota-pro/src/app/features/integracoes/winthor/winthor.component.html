<div class="page">
  <div class="header">
    <div>
      <h1>Integração WinThor</h1>
      <p>Controle sincronizações manuais/automáticas, monitore jobs e valide conectividade com Integradora/Oracle.</p>
    </div>

    <div class="actions">
      <button class="btn ghost" type="button" (click)="bootstrap()" [disabled]="loading">
        {{ loading ? 'Carregando...' : 'Recarregar' }}
      </button>

      <button class="btn primary" type="button" (click)="saveConfig()" [disabled]="saving || loading">
        {{ saving ? 'Salvando...' : 'Salvar configurações' }}
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div *ngIf="toast" class="toast"
       [class.ok]="toast.type==='success'"
       [class.err]="toast.type==='error'"
       [class.info]="toast.type==='info'">
    <span class="dot"></span>
    <span>{{ toast.text }}</span>
    <button class="toast-x" type="button" (click)="toast=null">×</button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab" [class.active]="tab==='overview'" (click)="setTab('overview')" type="button">Visão geral</button>
    <button class="tab" [class.active]="tab==='jobs'" (click)="setTab('jobs')" type="button">Jobs</button>
    <button class="tab" [class.active]="tab==='logs'" (click)="setTab('logs')" type="button">Logs</button>
  </div>

  <!-- ========================= -->
  <!-- OVERVIEW -->
  <!-- ========================= -->
  <ng-container *ngIf="tab==='overview'">
    <div class="grid-2">
      <!-- Config card -->
      <div class="card">
        <div class="card-h">
          <div>
            <h3>Configuração</h3>
            <p class="muted">Liga/desliga automação e escolhe o que sincronizar.</p>
          </div>
          <span class="badge" [class.on]="form.ativo" [class.off]="!form.ativo">
            {{ form.ativo ? 'ATIVA' : 'DESATIVADA' }}
          </span>
        </div>

        <div class="form">
          <label class="row">
            <span>Sincronização automática</span>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="form.ativo" />
              <span class="slider"></span>
            </label>
          </label>

          <label class="row">
            <span>Intervalo (min)</span>
            <input class="input" type="number" min="1" step="1"
                   [(ngModel)]="form.intervaloMin" placeholder="Opcional" />
          </label>

          <div class="sep"></div>

          <label class="row">
            <span>Sincronizar Caminhões</span>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="form.syncCaminhoes" />
              <span class="slider"></span>
            </label>
          </label>

          <label class="row">
            <span>Sincronizar Motoristas</span>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="form.syncMotoristas" />
              <span class="slider"></span>
            </label>
          </label>

          <label class="row">
            <span>Sincronizar Cargas</span>
            <label class="switch">
              <input type="checkbox" [(ngModel)]="form.syncCargas" />
              <span class="slider"></span>
            </label>
          </label>

          <div class="meta">
            <div class="meta-line">
              <span class="muted">Empresa</span>
              <span class="mono">{{ config?.empresaId || '-' }}</span>
            </div>
            <div class="meta-line">
              <span class="muted">Atualizado</span>
              <span>{{ formatDateTime(config?.atualizadoEm || null) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Status card -->
      <div class="card">
        <div class="card-h">
          <div>
            <h3>Status & Conectividade</h3>
            <p class="muted">API → Integradora → Oracle (via actuator health).</p>
          </div>
          <button class="btn small" type="button" (click)="refreshStatus()" [disabled]="statusLoading">
            {{ statusLoading ? 'Verificando...' : 'Atualizar status' }}
          </button>
        </div>

        <div class="status-grid">
          <div class="status-item">
            <div class="label muted">API</div>
            <div class="value">
              <span class="pill ok">UP</span>
            </div>
          </div>

          <div class="status-item">
            <div class="label muted">Integradora</div>
            <div class="value">
              <span class="{{ pillClass(status?.integradoraOk) }}">{{ status?.integradoraStatus || 'UNKNOWN' }}</span>
            </div>
          </div>

          <div class="status-item">
            <div class="label muted">Oracle</div>
            <div class="value">
              <span class="{{ pillClass(status?.oracleOk) }}">{{ status?.oracleStatus || 'UNKNOWN' }}</span>
            </div>
          </div>

          <div class="status-item">
            <div class="label muted">Latência</div>
            <div class="value">
              <span class="mono">{{ status?.latenciaMs != null ? (status?.latenciaMs + 'ms') : '-' }}</span>
            </div>
          </div>

          <div class="status-item">
            <div class="label muted">Verificado</div>
            <div class="value">
              <span>{{ formatDateTime(status?.verificadoEm || null) }}</span>
            </div>
          </div>
        </div>

        <div class="hint">
          <span class="muted">
            Dica: se a integradora estiver DOWN, verifique a URL em <span class="mono">frotapro.integracao.integradora-base-url</span>.
          </span>
        </div>
      </div>
    </div>

    <!-- Manual sync -->
    <div class="card">
      <div class="card-h">
        <div>
          <h3>Sincronização manual</h3>
          <p class="muted">Dispara sincronização sob demanda e acompanha nos Jobs.</p>
        </div>
        <button class="btn ghost small" type="button" (click)="refreshJobs()" [disabled]="jobsLoading">
          {{ jobsLoading ? 'Atualizando...' : 'Atualizar jobs' }}
        </button>
      </div>

      <div class="manual-grid">
        <div class="manual-box">
          <h4>Motoristas</h4>
          <p class="muted">Sincroniza motoristas do WinThor para o FrotaPRO.</p>
          <button class="btn primary" type="button" (click)="syncMotoristas()" [disabled]="refreshing">
            {{ refreshing ? 'Enviando...' : 'Sincronizar motoristas' }}
          </button>
        </div>

        <div class="manual-box">
          <h4>Caminhões</h4>
          <p class="muted">Sincroniza caminhões (opcional: filial).</p>

          <div class="inline">
            <input class="input" type="number" min="1" step="1"
                   [(ngModel)]="codFilial" placeholder="Cod. Filial (opcional)" />
            <button class="btn primary" type="button" (click)="syncCaminhoes()" [disabled]="refreshing">
              {{ refreshing ? 'Enviando...' : 'Sincronizar caminhões' }}
            </button>
          </div>
        </div>

        <div class="manual-box">
          <h4>Cargas</h4>
          <p class="muted">Sincroniza cargas por data (padrão: hoje).</p>

          <div class="inline">
            <input class="input" type="date" [(ngModel)]="dataCargas" />
            <button class="btn primary" type="button" (click)="syncCargas()" [disabled]="refreshing">
              {{ refreshing ? 'Enviando...' : 'Sincronizar cargas' }}
            </button>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- ========================= -->
  <!-- JOBS -->
  <!-- ========================= -->
  <ng-container *ngIf="tab==='jobs'">
    <div class="toolbar">
      <div class="left">
        <span class="muted">Tipo</span>
        <select class="select" [(ngModel)]="jobsTipo" (change)="refreshJobs()">
          <option value="TODOS">Todos</option>
          <option value="CARGAS">Cargas</option>
          <option value="CAMINHOES">Caminhões</option>
          <option value="MOTORISTAS">Motoristas</option>
        </select>

        <span class="muted">Limite</span>
        <select class="select" [(ngModel)]="pageSize" (change)="refreshJobs()">
          <option [ngValue]="25">25</option>
          <option [ngValue]="50">50</option>
          <option [ngValue]="100">100</option>
          <option [ngValue]="200">200</option>
        </select>
      </div>

      <div class="right">
        <button class="btn ghost" type="button" (click)="refreshJobs()" [disabled]="jobsLoading">
          {{ jobsLoading ? 'Atualizando...' : 'Atualizar' }}
        </button>
      </div>
    </div>

    <div class="grid-3">
      <!-- PENDENTES -->
      <div class="card">
        <div class="card-h">
          <div>
            <h3>Pendentes / Processando</h3>
            <p class="muted">Fila ativa (Kafka + integradora).</p>
          </div>
          <span class="counter">{{ jobsPendente.length }}</span>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
            <tr>
              <th>Tipo</th>
              <th>Status</th>
              <th>Data</th>
              <th class="right">Total</th>
              <th>Atualizado</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let r of jobsPendente">
              <td class="mono">{{ r.tipo }}</td>
              <td><span class="{{ chipClass(r.status) }}">{{ r.status }}</span></td>
              <td>{{ formatDate(r.dataReferencia || null) }}</td>
              <td class="right">{{ r.totalRegistros ?? '-' }}</td>
              <td>{{ formatDateTime(r.atualizadoEm || r.criadoEm || null) }}</td>
            </tr>

            <tr *ngIf="!jobsLoading && jobsPendente.length===0">
              <td colspan="5" class="muted center">Sem pendências.</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ERROS -->
      <div class="card">
        <div class="card-h">
          <div>
            <h3>Erros</h3>
            <p class="muted">Falhas que podem ser reenfileiradas.</p>
          </div>
          <span class="counter err">{{ jobsErro.length }}</span>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
            <tr>
              <th>Tipo</th>
              <th>Status</th>
              <th>Data</th>
              <th>Erro</th>
              <th></th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let r of jobsErro">
              <td class="mono">{{ r.tipo }}</td>
              <td><span class="{{ chipClass(r.status) }}">{{ r.status }}</span></td>
              <td>{{ formatDate(r.dataReferencia || null) }}</td>
              <td class="truncate" [title]="r.mensagemErro || ''">{{ r.mensagemErro || '-' }}</td>
              <td class="right">
                <button class="btn small danger" type="button" (click)="retryJob(r)">
                  Reenfileirar
                </button>
              </td>
            </tr>

            <tr *ngIf="!jobsLoading && jobsErro.length===0">
              <td colspan="5" class="muted center">Nenhum erro.</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- CONCLUÍDOS -->
      <div class="card">
        <div class="card-h">
          <div>
            <h3>Concluídos</h3>
            <p class="muted">Sincronizações finalizadas.</p>
          </div>
          <span class="counter ok">{{ jobsConcluido.length }}</span>
        </div>

        <div class="table-wrap">
          <table class="table">
            <thead>
            <tr>
              <th>Tipo</th>
              <th>Status</th>
              <th>Data</th>
              <th class="right">Total</th>
              <th>Finalizado</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let r of jobsConcluido">
              <td class="mono">{{ r.tipo }}</td>
              <td><span class="{{ chipClass(r.status) }}">{{ r.status }}</span></td>
              <td>{{ formatDate(r.dataReferencia || null) }}</td>
              <td class="right">{{ r.totalRegistros ?? '-' }}</td>
              <td>{{ formatDateTime(r.atualizadoEm || r.criadoEm || null) }}</td>
            </tr>

            <tr *ngIf="!jobsLoading && jobsConcluido.length===0">
              <td colspan="5" class="muted center">Nenhum concluído.</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="note">
      <span class="muted">
        Ação “Reenfileirar” marca o job como pendente e reenviará o evento com o mesmo <span class="mono">jobId</span>.
      </span>
    </div>
  </ng-container>

  <!-- ========================= -->
  <!-- LOGS -->
  <!-- ========================= -->
  <ng-container *ngIf="tab==='logs'">
    <div class="toolbar">
      <div class="left">
        <span class="muted">Fonte</span>
        <select class="select" [(ngModel)]="logSource" (change)="refreshLogs()">
          <option value="API">API</option>
          <option value="INTEGRADORA">Integradora</option>
        </select>

        <span class="muted">Linhas</span>
        <select class="select" [(ngModel)]="logLines" (change)="refreshLogs()">
          <option [ngValue]="200">200</option>
          <option [ngValue]="300">300</option>
          <option [ngValue]="500">500</option>
          <option [ngValue]="1000">1000</option>
          <option [ngValue]="2000">2000</option>
        </select>

        <span class="muted">Buscar</span>
        <input class="input" style="max-width:260px"
               [(ngModel)]="logSearch" (input)="applyLogFilter()"
               placeholder="Ex.: ERROR, jobId, Oracle, Kafka..." />
      </div>

      <div class="right">
        <button class="btn ghost" type="button" (click)="toggleAutoRefreshLogs()">
          {{ autoRefreshLogs ? 'Auto: ON' : 'Auto: OFF' }}
        </button>

        <button class="btn ghost" type="button" (click)="copyLogs()"
                [disabled]="(filteredLogLines?.length||0)===0">
          Copiar
        </button>

        <button class="btn primary" type="button" (click)="refreshLogs()" [disabled]="logsLoading">
          {{ logsLoading ? 'Atualizando...' : 'Atualizar' }}
        </button>
      </div>
    </div>

    <div class="card">
      <div class="card-h">
        <div>
          <h3>Logs — {{ logSource }}</h3>
          <p class="muted">
            Atualizado em: {{ formatDateTime(rawLogs?.fetchedAt || null) }}
            <span class="dot">•</span>
            Retornadas: {{ rawLogs?.linesReturned ?? 0 }}/{{ rawLogs?.linesRequested ?? logLines }}
            <span class="dot">•</span>
            Filtradas: {{ filteredLogLines?.length ?? 0 }}
          </p>
        </div>
      </div>

      <div class="log-wrap">
        <pre class="log-pre" *ngIf="(filteredLogLines?.length||0) > 0">{{ filteredLogLines.join('\n') }}</pre>

        <div class="empty" *ngIf="(filteredLogLines?.length||0) === 0">
          <div class="empty-title">Sem logs para mostrar</div>
          <div class="muted">
            Troque a fonte, aumente o número de linhas ou limpe o filtro de busca.
          </div>
        </div>
      </div>
    </div>
  </ng-container>
</div>
